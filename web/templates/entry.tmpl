<!DOCTYPE html>
<html lang="en">
<head>
  <title>{{ .title }}</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ .prefix  }}/static/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ .prefix  }}/static/css/dropzone.min.css">
  <link rel="stylesheet" href="{{ .prefix  }}/static/css/style.css">
  <script src="{{ .prefix  }}/static/js/jquery.min.js"></script>
  <script src="{{ .prefix  }}/static/js/bootstrap.min.js"></script>
  <script src="{{ .prefix  }}/static/js/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="{{ .prefix  }}/static/js/dropzone.min.js" type="text/javascript"></script>

</head>

<body id="droparea">

{{ template "menu.tmpl" }}

<div class="container">
  <div class="row">
    <div class="col-md-12">

    <form class="form-horizontal" method="post" action="{{ .prefix }}/entries/{{ .entry.ID }}/edit">
    <input class="form-control input-large" id="title" name="Title" value="{{ .entry.Title }}" />
    
    <h2>Markdown</h2>
    
    <input type="hidden" id="markdown" name="Markdown"/>
    <div class="col-md-6">
       <div id="editor">
       </div>
    </div>
    <div class="col-md-6" id="render">
    </div>
    </div>
  </div>
  <div class="row top-buffer">
<!-- Button -->
    <div class="col-md-12">
{{ if .editable }} 
        <button  name="btnsave" id="btnsave" class="btn btn-primary btn-lg">Save</button>
{{ end }}
        <button name="btnback" class="btn btn-normal btn-lg">Back</button>
    </div>
</div>
    </form>

  <div class="row top-buffer">
<div id="previews" class="dropzone-previews"></div>
</div>
  </div>

<script>

var localStorageDraft = "draft";
var localStorageOldDraft ="changed"
var originalMarkdown = "{{ .entry.Markdown }}"
var updateMarkdownTimeout = undefined

var editor = ace.edit("editor");
editor.setTheme("ace/theme/github");
editor.getSession().setMode("ace/mode/markdown");
editor.setValue(originalMarkdown)

draft = localStorage[localStorageDraft]
if (draft != undefined){
    if (confirm('Unsaved draft found. Recover it?')) {
        editor.setValue(draft, -1) // moves cursor to the start
        editor.setValue(draft, 1) // moves cursor to the end
    }
}
editor.$blockScrolling = Infinity

function updateMarkdownTimer() {
    if (updateMarkdownTimeout != undefined) {
        window.clearTimeout(updateMarkdownTimeout)
    }
    updateMarkdownTimeout = window.setTimeout(renderMarkdown, 2000)
}

var onMarkdownChanged = function() {
  if (editor.getValue() != originalMarkdown){
    localStorage[localStorageDraft]=editor.getValue()
  }
  var newHeight =editor.getSession().getScreenLength()* editor.renderer.lineHeight
  $('#editor').height(newHeight.toString() + "px");
  $('#editor-section').height(newHeight.toString() + "px");
  editor.resize();
  updateMarkdownTimer()
};

// Set initial size to match initial content
onMarkdownChanged();
editor.getSession().on('change', onMarkdownChanged);

$( "#btnsave" ).click(function() {
    $("#markdown").val(editor.getValue())
    localStorage.removeItem(localStorageDraft)
});

function renderMarkdown (  ) {
    $.ajax({
        type: "POST",
        url: "{{ .prefix  }}/markdown",
        data: JSON.stringify({ Markdown: editor.getValue()  }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
              $("#render").html(data.html);
	      $(".markdown table").addClass("table table-condensed");
        },
            failure: function(errMsg) {
            alert(errMsg);
        }
    });
}

$( window ).on('beforeunload',function() {
    draft = localStorage[localStorageDraft] 
    localStorage.removeItem(localStorageDraft)
    if (draft != undefined){
        var temp = draft
        setTimeout(function() {
            setTimeout(function() {
                 localStorage[localStorageDraft] = temp
            }, 1000);
        },1);
        return "Entry not saved, discard?"
    }
});

new Dropzone(document.body, { // Make the whole body a dropzone
    url: "/entries/{{ .entry.ID }}/edit/files",
    previewsContainer: "#previews", // Define the container to display the previews
    clickable: "#previews", // Define the element that should be used as click trigger to select files.
    addedfile: function(file) { console.log(file);  },
    error: function(file, response) {
        alert(response.error); 
    },
    success: function(file) {
        json = jQuery.parseJSON(file.xhr.response)
        if ( json.ico != "" ) {
            markdown = "[![]("+json.ico+")]("+json.path+")"+json.name
        } else {
            markdown ="![]("+json.path+")"
        }
        editor.insert(markdown);
    }
});


</script>

</body>
</html>

